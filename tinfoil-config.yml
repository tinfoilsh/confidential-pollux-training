shim-version: v0.2.14@sha256:24d59ce41ad00a05ab5a37708b0d8b07a7d09abb1b74b75ee4862f688d093949
cvm-version: 0.5.8
cpus: 16
memory: 262144
gpus: full

containers:
  # gcsfuse sidecar (read/write)
  - name: "gcsfuse"
    image: ""
    args: [
      "--cap-add", "SYS_ADMIN",
      "--device", "/dev/fuse",
      "--security-opt", "apparmor=unconfined",
      "-v", "/mnt/ramdisk/gcs-bucket:/gcs:rshared",
      "-v", "/mnt/ramdisk/gcloud_key.json:/key.json:ro",
      "-e", "BUCKET_NAME=pollux-enc-prod",
      "kapetacom/gcsfuse-ubuntu:v3.2.0"
    ]

  # Pollux training (RW over /gcs via gcsfuse)
  - name: "ml-training"
    image: ""
    args: [
      "--runtime", "nvidia",
      "--gpus", "all",
      "--ipc", "host",
      "--entrypoint", "python",
      "-v", "/mnt/ramdisk/gcs-bucket:/mnt/gcs",
      "-v", "/mnt/ramdisk/gcloud_key.json:/key.json:ro",
      "-e", "GOOGLE_APPLICATION_CREDENTIALS=/key.json",
      "-e", "GCS_BUCKET=pollux-enc-prod",
      "-e", "GCS_ACCESS=read-write",
      "-e", "POLLUX_LN_GCS_BUCKET=gs://pollux-enc-prod",
      "-e", "POLLUX_GCSFUSE_MOUNT_PATH=/mnt/gcs",
      "-e", "WANDB_API_KEY=$(awk -F': *' '$1~/^wandb-api-key$/{print $2; exit}' /mnt/ramdisk/external-config.yml)",
      "-e", "WANDB_ENTITY=$(awk -F': *' '$1~/^wandb-entity$/{print $2; exit}' /mnt/ramdisk/external-config.yml)",
      "-e", "WANDB_PROJECT=$(awk -F': *' '$1~/^wandb-project$/{print $2; exit}' /mnt/ramdisk/external-config.yml)",
      "-e", "HF_TOKEN=$(awk -F': *' '$1~/^hf-token$/{print $2; exit}' /mnt/ramdisk/external-config.yml)",
      "-e", "TINFOIL_API_KEY=$(awk -F': *' '$1~/^tinfoil-api-key$/{print $2; exit}' /mnt/ramdisk/external-config.yml)",
      "us-central1-docker.pkg.dev/workshop-labs-pbc/pollux-docker/ml-training@sha256:8d7531a4a1f5ac270a07c797bb466c72175fefbb9ba2dfc5d6cb2eba9b30b0db",
      "-m", "scripts.training_server"
    ]

shim:
  listen-port: 443
  upstream-port: 8000
  publish-attestation: true
  tls-challenge: dns
  paths:
    - /ping
    - /status
    - /train
    - /upload/start
    - /upload/batch
    - /upload/finalize
    - /cancel_task
    - /queue_status
    - /list_task_ids
    - /lock_state
    - /clear_queue
    - /list_models
